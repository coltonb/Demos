<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="icon" type="image/x-icon" href="img/favicon.ico" />
    <link rel="stylesheet" href="css/style.css" />
    <script type="text/javascript" src="js/dat.gui.min.js"></script>
    <script type="text/javascript" src="js/stats.min.js"></script>
    <title>Cellular</title>
  </head>

  <body>
    <div id="sidebar"></div>
    <div id="container">
      <canvas id="canvas" width="250" height="250"></canvas>
    </div>
    <script type="text/javascript" src="js/cellular.js"></script>
    <script type="text/javascript">
      const canvas = document.querySelector('#canvas');
      const cellSpace = new CellSpace(canvas);

      let controls = {
        run: true,
        mouseDown: false,
        mouseState: 1,
        currentSimulationIndex: cellSpace.currentSimulationName,
        interactionActive: true,
        interactionSize: 2,
        step: () => {
          cellSpace.step();
        },
        fillDensity: 0.1,
        clear: () => {
          cellSpace.clear();
        },
        fill: () => {
          cellSpace.fill(controls.fillDensity);
        },
        toggleCell: (x, y) => {
          for (let newY = y - controls.interactionSize; newY < y + controls.interactionSize; newY += 1) {
            for (let newX = x - controls.interactionSize; newX < x + controls.interactionSize; newX += 1) {
              const cell = cellSpace.getCell(newX, newY);
              if (controls.interactionActive) {
                if (cellSpace.currentSimulation.activeState !== undefined) {
                  cell.forceState(cellSpace.currentSimulation.activeState());
                } else {
                  cell.forceState(1);
                }
              } else {
                if (cellSpace.currentSimulation.inactiveState !== undefined) {
                  cell.forceState(cellSpace.currentSimulation.inactiveState());
                } else {
                  cell.forceState(0);
                }
              }
            }
          }
        },
        setCell: (x, y, state) => {
          if (cellSpace.isInBounds(x, y)) {
            cellSpace.getCell(x, y).forceState(state);
          }
        },
        setSimulation: name => {
          cellSpace.setCurrentSimulation(name);
        },
      };

      canvas.addEventListener('mousedown', e => {
        controls.mouseDown = true;
        const canvasBoundingRect = canvas.getBoundingClientRect();
        const x = Math.floor(
          canvas.getAttribute('width') *
            ((e.clientX - canvasBoundingRect.x) / canvasBoundingRect.width)
        );
        const y = Math.floor(
          canvas.getAttribute('height') *
            ((e.clientY - canvasBoundingRect.y) / canvasBoundingRect.height)
        );
        controls.mouseState = controls.toggleCell(x, y);
      });

      window.addEventListener('mouseup', () => (controls.mouseDown = false));

      canvas.addEventListener('mousemove', e => {
        if (controls.mouseDown) {
          const canvasBoundingRect = canvas.getBoundingClientRect();
          const x = Math.floor(
            canvas.getAttribute('width') *
              ((e.clientX - canvasBoundingRect.x) / canvasBoundingRect.width)
          );
          const y = Math.floor(
            canvas.getAttribute('height') *
              ((e.clientY - canvasBoundingRect.y) / canvasBoundingRect.height)
          );
          controls.mouseState = controls.toggleCell(x, y);
        }
      });

      const gui = new dat.GUI();

      const simulationFolder = gui.addFolder('Simulation');
      simulationFolder
        .add(controls, 'currentSimulationIndex', cellSpace.simulationNames)
        .name('Mode')
        .onChange(name => {
          controls.setSimulation(name);
          controls.fill();
        });
      simulationFolder.add(controls, 'run').name('Running');
      simulationFolder.add(controls, 'step').name('Step');

      const fillFolder = gui.addFolder('Fill');
      fillFolder.add(controls, 'fillDensity', 0.01, 1.0).name('Density');
      fillFolder.add(controls, 'fill').name('Fill');
      fillFolder.add(controls, 'clear').name('Clear');

      const interactionFolder = gui.addFolder('Interaction');
      interactionFolder.add(controls, 'interactionActive').name('Mode')
      interactionFolder.add(controls, 'interactionSize', 2, 6, 1).name('Brush Size')

      simulationFolder.open();
      fillFolder.open();
      interactionFolder.open();

      cellSpace.fill();

      const stats = new Stats();
      stats.showPanel(0);
      document.body.appendChild(stats.dom);

      function updateLoop() {
        stats.begin();
        if (controls.run) cellSpace.step();
        cellSpace.draw();
        stats.end();
        requestAnimationFrame(() => updateLoop());
      }

      updateLoop();
    </script>
  </body>
</html>
