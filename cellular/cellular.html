<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link rel="icon" type="image/x-icon" href="img/favicon.ico" />
    <link rel="stylesheet" href="css/style.css" />
    <script type="text/javascript" src="js/dat.gui.min.js"></script>
    <script type="text/javascript" src="js/stats.min.js"></script>
    <title>Cellular</title>
  </head>

  <body>
    <div id="sidebar"></div>
    <div id="container">
      <canvas id="canvas" width="250" height="250"></canvas>
    </div>
    <script type="text/javascript" src="js/cellular.js"></script>
    <script type="text/javascript">
      const canvas = document.querySelector('#canvas');
      const cellSpace = new CellSpace(canvas);

      let controls = {
        scale: 2.0,
        run: true,
        mouseDown: false,
        mouseState: 1,
        currentSimulation: cellSpace.currentSimulationName,
        step: () => {
          cellSpace.step();
        },
        fillDensity: 0.1,
        clear: () => {
          cellSpace.clear();
        },
        randomFill: () => {
          cellSpace.randomFill(controls.fillDensity);
        },
        toggleCell: (x, y) => {
          if (cellSpace.isInBounds(x, y)) {
            const cell = cellSpace.getCell(x, y);
            if (cell.state === 0) {
              cell.forceState(1);
              return 1;
            } else {
              cell.forceState(0);
              return 0;
            }
          }
        },
        setCell: (x, y, state) => {
          if (cellSpace.isInBounds(x, y)) {
            cellSpace.getCell(x, y).forceState(state);
          }
        },
        setSimulation: name => {
          cellSpace.setCurrentSimulation(name);
        }
      };

      canvas.addEventListener('mousedown', e => {
        controls.mouseDown = true;
        controls.mouseState = controls.toggleCell(e.offsetX, e.offsetY);
      });

      window.addEventListener('mouseup', () => (controls.mouseDown = false));

      canvas.addEventListener('mousemove', e => {
        if (controls.mouseDown) {
          controls.setCell(e.offsetX, e.offsetY, controls.mouseState);
        }
      });

      const gui = new dat.GUI();

      const viewFolder = gui.addFolder('View');
      const scaleController = viewFolder.add(controls, 'scale', 1, 3);
      scaleController.name('Scale');
      scaleController.onChange(() => cellSpace.rescale(controls.scale));

      const simulationFolder = gui.addFolder('Simulation');
      simulationFolder
        .add(controls, 'currentSimulation', cellSpace.simulationNames)
        .name('Sim Mode')
        .onChange(name => {
          controls.setSimulation(name);
          controls.randomFill();
        });
      simulationFolder.add(controls, 'run').name('Running');
      simulationFolder.add(controls, 'step').name('Step');

      const fillFolder = gui.addFolder('Fill');
      fillFolder.add(controls, 'fillDensity', 0.01, 1.0).name('Density');
      fillFolder.add(controls, 'randomFill').name('Fill');
      fillFolder.add(controls, 'clear').name('Clear');

      simulationFolder.open();
      viewFolder.open();

      cellSpace.randomFill();

      const stats = new Stats();
      stats.showPanel(0);
      document.body.appendChild(stats.dom);

      function updateLoop() {
        stats.begin();
        if (controls.run) cellSpace.step();
        cellSpace.draw();
        stats.end();
        requestAnimationFrame(() => updateLoop());
      }

      updateLoop();
    </script>
  </body>
</html>
